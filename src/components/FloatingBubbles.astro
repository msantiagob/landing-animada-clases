---
---

<div class="floating-bubbles">
  <button
    class="bubble bubble-ai"
    id="ai-bubble-btn"
    aria-label="Asistente IA"
    aria-expanded="false"
    title="Asistente IA"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22" aria-hidden="true">
      <path d="M12 2a1 1 0 0 1 .967.744l1.526 5.692 5.692 1.526a1 1 0 0 1 0 1.976l-5.692 1.526-1.526 5.692a1 1 0 0 1-1.934 0l-1.526-5.692-5.692-1.526a1 1 0 0 1 0-1.976l5.692-1.526 1.526-5.692A1 1 0 0 1 12 2ZM5.5 16a.75.75 0 0 1 .725.556l.574 2.146 2.146.574a.75.75 0 0 1 0 1.448l-2.146.574-.574 2.146a.75.75 0 0 1-1.45 0l-.574-2.146-2.146-.574a.75.75 0 0 1 0-1.448l2.146-.574.574-2.146A.75.75 0 0 1 5.5 16ZM19 2a.75.75 0 0 1 .725.556l.38 1.42 1.42.38a.75.75 0 0 1 0 1.448l-1.42.38-.38 1.42a.75.75 0 0 1-1.45 0l-.38-1.42-1.42-.38a.75.75 0 0 1 0-1.448l1.42-.38.38-1.42A.75.75 0 0 1 19 2Z"/>
    </svg>
  </button>

  <a
    href="https://wa.me/573106041144"
    target="_blank"
    rel="noopener noreferrer"
    class="bubble bubble-wa"
    aria-label="Contactar por WhatsApp"
    title="WhatsApp"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22" aria-hidden="true">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
    </svg>
  </a>
</div>

<!-- Panel de chat IA -->
<div class="ai-panel" id="ai-panel" aria-hidden="true" role="dialog" aria-labelledby="ai-panel-title">
  <div class="ai-header">
    <div class="ai-header-left">
      <div class="ai-avatar" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
          <path d="M12 2a1 1 0 0 1 .967.744l1.526 5.692 5.692 1.526a1 1 0 0 1 0 1.976l-5.692 1.526-1.526 5.692a1 1 0 0 1-1.934 0l-1.526-5.692-5.692-1.526a1 1 0 0 1 0-1.976l5.692-1.526 1.526-5.692A1 1 0 0 1 12 2Z"/>
        </svg>
      </div>
      <div>
        <p class="ai-name" id="ai-panel-title">Asistente IA</p>
        <p class="ai-status"><span class="status-dot" aria-hidden="true"></span>En lÃ­nea</p>
      </div>
    </div>
    <button class="ai-close" id="ai-panel-close" aria-label="Cerrar chat">&times;</button>
  </div>

  <div class="ai-messages" id="ai-messages" role="log" aria-live="polite">
    <div class="msg msg-bot">
      <p>Â¡Hola! ðŸ‘‹ Soy el asistente de <strong>Miguel Zuluaga</strong>. Â¿Tienes dudas sobre las clases de IA, precios o metodologÃ­a? PregÃºntame.</p>
    </div>
  </div>

  <form class="ai-form" id="ai-form" autocomplete="off">
    <input
      type="text"
      id="ai-input"
      class="ai-input"
      placeholder="Escribe tu preguntaâ€¦"
      autocomplete="off"
      aria-label="Mensaje"
    />
    <button type="submit" class="ai-send" aria-label="Enviar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </form>
</div>

<script>
  // â”€â”€ Gemini config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const GEMINI_KEY = ""; // <- Agregar clave de Gemini API aquÃ­

  const SYSTEM_PROMPT = `Eres el asistente virtual de Miguel Zuluaga (sonmyd), experto en Inteligencia Artificial que ofrece clases personalizadas 1 a 1 en espaÃ±ol.

Tu rol es responder preguntas de visitantes sobre:
- Clases personalizadas de IA: desde fundamentos hasta nivel avanzado, formato 1 a 1
- Planes: Clase Individual ($25 USD/sesiÃ³n o $80.000 COP) y Paquete Intensivo ($220 USD / 10 horas o $750.000 COP)
- Primera sesiÃ³n de diagnÃ³stico de 30 minutos COMPLETAMENTE GRATIS
- La clase individual incluye: sesiÃ³n de 60 min, material de apoyo y grabaciÃ³n de la clase
- El paquete intensivo incluye ademÃ¡s: seguimiento continuo, soporte y proyecto real de portafolio
- Para reservar, el visitante puede hacer clic en los botones de planes o escribir a WhatsApp

SÃ© amable, entusiasta y conciso. Responde SIEMPRE en espaÃ±ol. Motiva al usuario a reservar su primera sesiÃ³n gratuita.`;

  // â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const bubbleBtn = document.getElementById("ai-bubble-btn") as HTMLButtonElement;
  const panel = document.getElementById("ai-panel")!;
  const closeBtn = document.getElementById("ai-panel-close")!;
  const messagesEl = document.getElementById("ai-messages")!;
  const form = document.getElementById("ai-form") as HTMLFormElement;
  const input = document.getElementById("ai-input") as HTMLInputElement;

  let isOpen = false;
  let history: { role: string; parts: { text: string }[] }[] = [];

  // â”€â”€ Panel open/close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function togglePanel() {
    isOpen = !isOpen;
    panel.classList.toggle("is-open", isOpen);
    panel.setAttribute("aria-hidden", String(!isOpen));
    bubbleBtn.setAttribute("aria-expanded", String(isOpen));
    if (isOpen) setTimeout(() => input.focus(), 300);
  }

  bubbleBtn.addEventListener("click", togglePanel);
  closeBtn.addEventListener("click", togglePanel);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && isOpen) togglePanel();
  });

  // â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addMessage(text: string, role: "user" | "bot") {
    const div = document.createElement("div");
    div.className = `msg msg-${role}`;
    const p = document.createElement("p");
    p.innerHTML = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>").replace(/\n/g, "<br>");
    div.appendChild(p);
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function showTyping() {
    const div = document.createElement("div");
    div.className = "msg msg-typing";
    div.id = "typing-indicator";
    div.innerHTML = "<span></span><span></span><span></span>";
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return div;
  }

  // â”€â”€ Gemini API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendToGemini(userText: string): Promise<string> {
    history.push({ role: "user", parts: [{ text: userText }] });

    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
          contents: history,
        }),
      }
    );

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const reply: string =
      data.candidates?.[0]?.content?.parts?.[0]?.text ??
      "Lo siento, no pude procesar tu mensaje.";

    history.push({ role: "model", parts: [{ text: reply }] });
    return reply;
  }

  // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    input.value = "";
    input.disabled = true;
    addMessage(text, "user");
    const typing = showTyping();

    try {
      if (!GEMINI_KEY) {
        throw new Error("No key");
      }
      const reply = await sendToGemini(text);
      typing.remove();
      addMessage(reply, "bot");
    } catch {
      typing.remove();
      addMessage(
        GEMINI_KEY
          ? "OcurriÃ³ un error. Por favor intenta de nuevo."
          : "El asistente aÃºn no estÃ¡ configurado. EscrÃ­benos por WhatsApp. ðŸ˜Š",
        "bot"
      );
    } finally {
      input.disabled = false;
      input.focus();
    }
  });
</script>

<style>
  /* â”€â”€ Burbujas flotantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .floating-bubbles {
    position: fixed;
    left: 1.5rem;
    bottom: 2rem;
    z-index: 400;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;

    @media (max-width: 480px) {
      left: 1rem;
      bottom: 1.25rem;
    }
  }

  .bubble {
    width: 3.25rem;
    height: 3.25rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    text-decoration: none;
    color: #fff;
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;

    &:hover {
      transform: translateY(-3px) scale(1.08);
    }

    &:active {
      transform: scale(0.96);
    }
  }

  /* WhatsApp */
  .bubble-wa {
    background: #25d366;
    box-shadow:
      0 4px 20px rgba(37, 211, 102, 0.45),
      0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* IA */
  .bubble-ai {
    background: rgb(var(--rgb-brand-2));
    box-shadow:
      0 4px 20px rgba(50, 170, 255, 0.45),
      0 2px 8px rgba(0, 0, 0, 0.3);

    &::before {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid rgba(50, 170, 255, 0.6);
      animation: pulse-ring 2.5s infinite ease-out;
    }
  }

  @keyframes pulse-ring {
    0% {
      transform: scale(0.92);
      opacity: 0.8;
    }
    70% {
      transform: scale(1.25);
      opacity: 0;
    }
    100% {
      transform: scale(1.25);
      opacity: 0;
    }
  }

  /* â”€â”€ Panel de chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ai-panel {
    position: fixed;
    left: 1.5rem;
    bottom: 10.5rem;
    width: min(22rem, calc(100vw - 2rem));
    max-height: 32rem;
    background: rgb(var(--rgb-brand-3));
    border: 1px solid rgba(50, 170, 255, 0.25);
    border-radius: 1.25rem;
    z-index: 399;
    display: flex;
    flex-direction: column;
    box-shadow:
      0 8px 40px rgba(0, 0, 0, 0.55),
      0 0 60px rgba(50, 170, 255, 0.08);
    opacity: 0;
    pointer-events: none;
    transform: translateY(0.75rem) scale(0.97);
    transform-origin: bottom left;
    transition:
      opacity 0.25s ease,
      transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);

    &.is-open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }

    @media (max-width: 480px) {
      left: 1rem;
      bottom: 9.5rem;
      width: calc(100vw - 2rem);
    }
  }

  /* Header */
  .ai-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1rem 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.07);
    flex-shrink: 0;
  }

  .ai-header-left {
    display: flex;
    align-items: center;
    gap: 0.625rem;
  }

  .ai-avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: rgba(50, 170, 255, 0.15);
    border: 1px solid rgba(50, 170, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(var(--rgb-brand-2));
    flex-shrink: 0;
  }

  .ai-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(240, 240, 250);
    margin: 0;
    line-height: 1.2;
  }

  .ai-status {
    font-size: 0.7rem;
    color: rgba(240, 240, 250, 0.5);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    line-height: 1;
    margin-top: 0.2rem;
  }

  .status-dot {
    width: 0.45rem;
    height: 0.45rem;
    border-radius: 50%;
    background: #4ade80;
    display: inline-block;
    flex-shrink: 0;
  }

  .ai-close {
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.07);
    border: none;
    color: rgba(240, 240, 250, 0.6);
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    flex-shrink: 0;

    &:hover {
      background: rgba(255, 255, 255, 0.13);
      color: rgb(240, 240, 250);
    }
  }

  /* Messages */
  .ai-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    scroll-behavior: smooth;

    &::-webkit-scrollbar {
      width: 4px;
    }
    &::-webkit-scrollbar-track {
      background: transparent;
    }
    &::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }
  }

  .msg {
    max-width: 88%;

    p {
      margin: 0;
      padding: 0.6rem 0.875rem;
      border-radius: 1rem;
      font-size: 0.82rem;
      line-height: 1.55;
    }

    strong {
      font-weight: 600;
    }
  }

  .msg-bot {
    align-self: flex-start;

    p {
      background: rgba(255, 255, 255, 0.07);
      color: rgba(240, 240, 250, 0.92);
      border-bottom-left-radius: 0.25rem;
    }
  }

  .msg-user {
    align-self: flex-end;

    p {
      background: rgb(var(--rgb-brand-2));
      color: #fff;
      border-bottom-right-radius: 0.25rem;
    }
  }

  /* Typing indicator */
  .msg-typing {
    align-self: flex-start;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.07);
    border-radius: 1rem;
    border-bottom-left-radius: 0.25rem;

    span {
      width: 0.375rem;
      height: 0.375rem;
      border-radius: 50%;
      background: rgba(240, 240, 250, 0.45);
      display: block;
      animation: typing-dot 1.2s infinite ease-in-out;

      &:nth-child(2) {
        animation-delay: 0.2s;
      }
      &:nth-child(3) {
        animation-delay: 0.4s;
      }
    }
  }

  @keyframes typing-dot {
    0%,
    60%,
    100% {
      transform: translateY(0);
      opacity: 0.45;
    }
    30% {
      transform: translateY(-0.3rem);
      opacity: 1;
    }
  }

  /* Input row */
  .ai-form {
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.07);
    flex-shrink: 0;
  }

  .ai-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 0.6rem 0.875rem;
    color: rgb(240, 240, 250);
    font-size: 0.82rem;
    outline: none;
    transition: border-color 0.2s;
    min-width: 0;

    &::placeholder {
      color: rgba(240, 240, 250, 0.3);
    }

    &:focus {
      border-color: rgba(50, 170, 255, 0.5);
    }

    &:disabled {
      opacity: 0.6;
    }
  }

  .ai-send {
    width: 2.375rem;
    height: 2.375rem;
    border-radius: 0.625rem;
    background: rgb(var(--rgb-brand-2));
    border: none;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s, transform 0.15s;
    flex-shrink: 0;

    &:hover {
      opacity: 0.85;
      transform: scale(1.05);
    }

    &:active {
      transform: scale(0.96);
    }
  }
</style>
