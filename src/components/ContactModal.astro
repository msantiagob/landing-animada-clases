---
---

<div id="contact-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="modal-heading">
    <button class="modal-close" aria-label="Cerrar">&times;</button>
    <div class="modal-content">
      <h2 id="modal-heading" class="modal-title">Reserva tu sesiÃ³n</h2>
      <p class="modal-subtitle">
        DÃ©janos tus datos y te contactamos para confirmar tu clase.
      </p>
      <p class="modal-plan-label" id="modal-plan-label"></p>

      <form id="contact-form" novalidate>
        <input type="hidden" id="modal-plan" name="plan" />

        <!-- Honeypot: invisible para humanos, los bots lo llenan -->
        <div class="hp-field" aria-hidden="true">
          <input type="text" name="website" tabindex="-1" autocomplete="off" />
        </div>

        <div class="field" id="field-nombre">
          <label for="modal-nombre">Nombre</label>
          <input
            type="text"
            id="modal-nombre"
            name="nombre"
            required
            maxlength="80"
            placeholder="Tu nombre completo"
            autocomplete="name"
          />
          <span class="field-error" id="error-nombre"></span>
        </div>

        <div class="field" id="field-correo">
          <label for="modal-correo">Correo electrÃ³nico</label>
          <input
            type="email"
            id="modal-correo"
            name="correo"
            required
            maxlength="120"
            placeholder="tu@correo.com"
            autocomplete="email"
          />
          <span class="field-error" id="error-correo"></span>
        </div>

        <div class="field" id="field-telefono">
          <label for="modal-telefono">TelÃ©fono / WhatsApp</label>
          <input
            type="tel"
            id="modal-telefono"
            name="telefono"
            required
            maxlength="20"
            placeholder="+57 300 000 0000"
            autocomplete="tel"
          />
          <span class="field-error" id="error-telefono"></span>
        </div>

        <button type="submit" class="submit-btn" id="modal-submit">
          <span class="submit-text">Enviar solicitud</span>
          <span class="submit-loading" aria-hidden="true">Enviandoâ€¦</span>
        </button>

        <p class="form-success" id="modal-success" role="alert" aria-live="polite"></p>
        <p class="form-error-global" id="modal-error" role="alert" aria-live="polite"></p>
      </form>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://agwzcghaojhdjniuujbl.supabase.co";
  const SUPABASE_KEY = "sb_publishable_l2VskysoUrgHt1U5WX8hBg_FXPfhHVa";
  const RATE_LIMIT_MS = 60_000; // 60 segundos entre envÃ­os
  const RATE_LIMIT_KEY = "contact_last_submit";

  const modal = document.getElementById("contact-modal")!;
  const backdrop = modal.querySelector(".modal-backdrop")!;
  const closeBtn = modal.querySelector(".modal-close")!;
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const planInput = document.getElementById("modal-plan") as HTMLInputElement;
  const planLabel = document.getElementById("modal-plan-label")!;
  const submitBtn = document.getElementById("modal-submit") as HTMLButtonElement;
  const successEl = document.getElementById("modal-success")!;
  const errorEl = document.getElementById("modal-error")!;
  const headingEl = document.getElementById("modal-heading")!;
  const subtitleEl = modal.querySelector(".modal-subtitle")!;

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function sanitize(value: string): string {
    return value
      .trim()
      .replace(/<[^>]*>/g, "")          // strip HTML tags
      .replace(/[<>"'`;\\]/g, "")       // strip chars usados en inyecciones
      .slice(0, 200);                    // hard limit
  }

  function isValidName(v: string): boolean {
    return v.length >= 2 && v.length <= 80 && /^[\p{L}\s'\-\.]+$/u.test(v);
  }

  function isValidEmail(v: string): boolean {
    return /^[^\s@]{1,64}@[^\s@]{1,255}\.[^\s@]{2,}$/.test(v);
  }

  function isValidPhone(v: string): boolean {
    return /^[\d\s+\-().]{6,20}$/.test(v);
  }

  function setFieldState(
    fieldId: string,
    errorId: string,
    valid: boolean,
    msg = ""
  ) {
    const field = document.getElementById(fieldId)!;
    const errEl = document.getElementById(errorId)!;
    field.classList.toggle("field--error", !valid);
    field.classList.toggle("field--valid", valid);
    errEl.textContent = valid ? "" : msg;
  }

  function clearFieldState(fieldId: string, errorId: string) {
    const field = document.getElementById(fieldId)!;
    document.getElementById(errorId)!.textContent = "";
    field.classList.remove("field--error", "field--valid");
  }

  // â”€â”€ ValidaciÃ³n en blur (al salir de cada campo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const nombreInput = form.elements.namedItem("nombre") as HTMLInputElement;
  const correoInput = form.elements.namedItem("correo") as HTMLInputElement;
  const telefonoInput = form.elements.namedItem("telefono") as HTMLInputElement;

  nombreInput.addEventListener("blur", () => {
    const v = sanitize(nombreInput.value);
    if (!v) return clearFieldState("field-nombre", "error-nombre");
    setFieldState(
      "field-nombre", "error-nombre",
      isValidName(v),
      "Solo letras y espacios, mÃ­nimo 2 caracteres."
    );
  });

  correoInput.addEventListener("blur", () => {
    const v = sanitize(correoInput.value);
    if (!v) return clearFieldState("field-correo", "error-correo");
    setFieldState(
      "field-correo", "error-correo",
      isValidEmail(v),
      "Ingresa un correo vÃ¡lido (ej: tu@correo.com)."
    );
  });

  telefonoInput.addEventListener("blur", () => {
    const v = sanitize(telefonoInput.value);
    if (!v) return clearFieldState("field-telefono", "error-telefono");
    setFieldState(
      "field-telefono", "error-telefono",
      isValidPhone(v),
      "Solo nÃºmeros, +, - y espacios (6â€“20 caracteres)."
    );
  });

  // Limpiar estado visual al empezar a escribir
  [nombreInput, correoInput, telefonoInput].forEach((input) => {
    input.addEventListener("input", () => {
      input.closest(".field")?.classList.remove("field--error", "field--valid");
    });
  });

  // â”€â”€ Modal open / close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function openModal(planName: string) {
    const isFree = planName === "SesiÃ³n Gratuita";
    headingEl.textContent = isFree ? "Reserva tu sesiÃ³n gratuita" : "Reserva tu sesiÃ³n";
    subtitleEl.textContent = isFree
      ? "30 minutos de diagnÃ³stico sin costo. Nos conocemos, evaluamos tu nivel y definimos el plan ideal para ti."
      : "DÃ©janos tus datos y te contactamos para confirmar tu clase.";
    planLabel.textContent = isFree ? "ðŸŽ Primera sesiÃ³n gratis" : planName ? `Plan: ${planName}` : "";

    planInput.value = planName;
    modal.setAttribute("aria-hidden", "false");
    modal.classList.add("is-open");
    document.body.style.overflow = "hidden";
    successEl.textContent = "";
    errorEl.textContent = "";
    submitBtn.disabled = false;
    submitBtn.classList.remove("loading");
    form.reset();
    planInput.value = planName;
    // Limpiar estados visuales al abrir
    ["field-nombre", "field-correo", "field-telefono"].forEach((id) => {
      document.getElementById(id)?.classList.remove("field--error", "field--valid");
    });
    ["error-nombre", "error-correo", "error-telefono"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.textContent = "";
    });
    setTimeout(() => nombreInput.focus(), 100);
  }

  function closeModal() {
    modal.setAttribute("aria-hidden", "true");
    modal.classList.remove("is-open");
    document.body.style.overflow = "";
  }

  document.addEventListener("click", (e) => {
    const btn = (e.target as Element).closest("[data-modal-plan]");
    if (!btn) return;
    e.preventDefault();
    openModal(btn.getAttribute("data-modal-plan") ?? "");
  });

  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
  });

  // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    successEl.textContent = "";
    errorEl.textContent = "";

    // 1. Honeypot check
    const honeypot = (form.elements.namedItem("website") as HTMLInputElement).value;
    if (honeypot) return; // bot detectado, silently drop

    // 2. Rate limiting
    const lastSubmit = Number(localStorage.getItem(RATE_LIMIT_KEY) ?? 0);
    const remaining = Math.ceil((RATE_LIMIT_MS - (Date.now() - lastSubmit)) / 1000);
    if (Date.now() - lastSubmit < RATE_LIMIT_MS) {
      errorEl.textContent = `Espera ${remaining}s antes de volver a enviar.`;
      return;
    }

    // 3. Sanitize
    const nombre   = sanitize(nombreInput.value);
    const correo   = sanitize(correoInput.value);
    const telefono = sanitize(telefonoInput.value);
    const plan     = sanitize(planInput.value);

    // 4. Validate all fields
    let valid = true;

    if (!nombre || !isValidName(nombre)) {
      setFieldState("field-nombre", "error-nombre", false, "Solo letras y espacios, mÃ­nimo 2 caracteres.");
      valid = false;
    } else {
      setFieldState("field-nombre", "error-nombre", true);
    }

    if (!correo || !isValidEmail(correo)) {
      setFieldState("field-correo", "error-correo", false, "Ingresa un correo vÃ¡lido (ej: tu@correo.com).");
      valid = false;
    } else {
      setFieldState("field-correo", "error-correo", true);
    }

    if (!telefono || !isValidPhone(telefono)) {
      setFieldState("field-telefono", "error-telefono", false, "Solo nÃºmeros, +, - y espacios (6â€“20 caracteres).");
      valid = false;
    } else {
      setFieldState("field-telefono", "error-telefono", true);
    }

    if (!valid) return;

    // 5. Submit
    submitBtn.disabled = true;
    submitBtn.classList.add("loading");

    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/leads`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          Prefer: "return=minimal",
        },
        body: JSON.stringify({ nombre, correo, telefono, plan }),
      });

      if (!res.ok) throw new Error(await res.text());

      localStorage.setItem(RATE_LIMIT_KEY, String(Date.now()));
      successEl.textContent = "Â¡Listo! Te contactaremos pronto para confirmar tu sesiÃ³n.";
      form.reset();
      planInput.value = plan;
      ["field-nombre", "field-correo", "field-telefono"].forEach((id) => {
        document.getElementById(id)?.classList.remove("field--error", "field--valid");
      });
    } catch {
      errorEl.textContent = "OcurriÃ³ un error al enviar. IntÃ©ntalo de nuevo.";
    } finally {
      submitBtn.disabled = false;
      submitBtn.classList.remove("loading");
    }
  });
</script>

<style>
  /* Ocultar honeypot de forma accesible */
  .hp-field {
    position: absolute;
    left: -9999px;
    opacity: 0;
    pointer-events: none;
    height: 0;
    overflow: hidden;
  }

  .modal {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.25s ease;

    &.is-open {
      opacity: 1;
      pointer-events: auto;
    }
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-box {
    position: relative;
    z-index: 1;
    background: rgb(var(--rgb-brand-3));
    border: 1px solid rgba(50, 170, 255, 0.25);
    border-radius: 1.25rem;
    width: 100%;
    max-width: 26rem;
    box-shadow:
      0 0 60px rgba(50, 170, 255, 0.15),
      0 0 120px rgba(68, 196, 255, 0.08),
      0 24px 48px rgba(0, 0, 0, 0.5);
    transform: translateY(1rem) scale(0.97);
    transition:
      transform 0.3s var(--ease-out-cubic, cubic-bezier(0.22, 1, 0.36, 1)),
      opacity 0.3s ease;
    opacity: 0;

    .is-open & {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  .modal-content {
    padding: 2.5rem 2rem 2rem;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 2rem;
    height: 2rem;
    background: rgba(255, 255, 255, 0.07);
    border: none;
    border-radius: 50%;
    color: rgba(240, 240, 250, 0.6);
    font-size: 1.25rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;

    &:hover {
      background: rgba(255, 255, 255, 0.14);
      color: rgb(240, 240, 250);
    }
  }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgb(240, 240, 250);
    margin: 0 0 0.4rem;
  }

  .modal-subtitle {
    font-size: 0.875rem;
    color: rgba(240, 240, 250, 0.55);
    margin: 0 0 1.25rem;
    line-height: 1.5;
  }

  .modal-plan-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgb(var(--rgb-brand-2));
    background: rgba(var(--rgb-brand-2), 0.1);
    border: 1px solid rgba(var(--rgb-brand-2), 0.25);
    border-radius: 999px;
    display: inline-block;
    padding: 0.2em 0.85em;
    margin-bottom: 1.5rem;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: 1rem;

    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(240, 240, 250, 0.7);
    }

    input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.6rem;
      padding: 0.75rem 1rem;
      color: rgb(240, 240, 250);
      font-size: 0.9rem;
      width: 100%;
      transition: border-color 0.2s, background 0.2s;
      outline: none;

      &::placeholder {
        color: rgba(240, 240, 250, 0.3);
      }

      &:focus {
        border-color: rgba(50, 170, 255, 0.6);
        background: rgba(50, 170, 255, 0.04);
      }
    }

    &.field--error input {
      border-color: rgba(235, 14, 56, 0.7);
      background: rgba(235, 14, 56, 0.04);
    }

    &.field--valid input {
      border-color: rgba(74, 222, 128, 0.5);
    }
  }

  .field-error {
    font-size: 0.75rem;
    color: rgba(235, 14, 56, 0.9);
    min-height: 1em;
    line-height: 1.3;
  }

  .submit-btn {
    margin-top: 0.5rem;
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: #1855CC;
    color: #fff;
    font-size: 0.9rem;
    font-weight: 600;
    border: none;
    border-radius: 0.7rem;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.15s;
    position: relative;

    &:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    &:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .submit-loading {
      display: none;
    }

    &.loading .submit-text {
      display: none;
    }

    &.loading .submit-loading {
      display: inline;
    }
  }

  .form-success {
    margin-top: 0.9rem;
    font-size: 0.82rem;
    color: #4ade80;
    text-align: center;
    min-height: 1.2em;
  }

  .form-error-global {
    margin-top: 0.9rem;
    font-size: 0.82rem;
    color: rgb(var(--rgb-brand-1));
    text-align: center;
    min-height: 1.2em;
  }
</style>
